<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Transaksi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 900px;
        }
        .table th, .table td {
            text-align: center;
        }
        .table td button {
            width: 100px;
        }
        .struk-container {
            display: none;
            background-color: #fff;
            border: 2px solid #ddd;
            padding: 20px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <script>
        validateAccess("transaksi");
    </script>

    <!-- Navbar diambil dari script di halaman sebelumnya -->

    <div class="container mt-5">
        <h2 class="text-center mb-4"><i class="fas fa-cart-plus"></i> Manajemen Transaksi</h2>

        <!-- Pilihan Jenis Pelanggan (Umum, Member, Semi) -->
        <div class="mb-4">
            <label for="jenisPelanggan" class="form-label">Pilih Jenis Pelanggan</label>
            <select class="form-control" id="jenisPelanggan">
                <option value="umum">Umum</option>
                <option value="member">Member</option>
                <option value="semi">Semi</option>
            </select>
        </div>

        <!-- Form Transaksi Umum (Input Manual) -->
        <div id="formTransaksiUmum">
            <form id="transaksiForm">
                <div class="mb-3">
                    <label for="transaksiId" class="form-label">ID Transaksi</label>
                    <input type="text" class="form-control" id="transaksiId" disabled value="TRX-{{randomId}}">
                </div>
                <div class="mb-3">
                    <label for="produkId" class="form-label">Pilih Produk</label>
                    <select class="form-control" id="produkId" required>
                        <!-- Opsi produk akan dimuat di sini -->
                    </select>
                </div>
                <div class="mb-3">
                    <label for="jumlah" class="form-label">Jumlah</label>
                    <input type="number" class="form-control" id="jumlah" required>
                </div>
                <div class="mb-3">
                    <label for="diskon" class="form-label">Diskon (%)</label>
                    <input type="number" class="form-control" id="diskon" value="0" required>
                </div>
                <div class="mb-3">
                    <label for="total" class="form-label">Total</label>
                    <input type="number" class="form-control" id="total" disabled>
                </div>
                <div class="mb-3">
                    <label for="bayar" class="form-label">Bayar</label>
                    <input type="number" class="form-control" id="bayar" required>
                </div>
                <div class="mb-3">
                    <label for="buktiBayar" class="form-label">Bukti Bayar</label>
                    <input type="file" class="form-control" id="buktiBayar" required>
                </div>
                <button type="submit" class="btn btn-success w-100" id="submitButton">
                    <i class="fas fa-save"></i> Simpan Transaksi
                </button>
            </form>
        </div>

        <!-- Modal untuk transaksi Member -->
        <div class="modal fade" id="modalTransaksiMember" tabindex="-1" aria-labelledby="modalTransaksiMemberLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTransaksiMemberLabel">Transaksi Member</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="transaksiMemberForm">
                            <div class="mb-3">
                                <label for="memberId" class="form-label">ID Member</label>
                                <input type="text" class="form-control" id="memberId" required>
                            </div>
                            <div class="mb-3">
                                <label for="produkMember" class="form-label">Produk</label>
                                <select class="form-control" id="produkMember" required>
                                    <!-- Opsi produk akan dimuat di sini -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="jumlahMember" class="form-label">Jumlah</label>
                                <input type="number" class="form-control" id="jumlahMember" required>
                            </div>
                            <div class="mb-3">
                                <label for="diskonMember" class="form-label">Diskon (%)</label>
                                <input type="number" class="form-control" id="diskonMember" value="0" required>
                            </div>
                            <div class="mb-3">
                                <label for="totalMember" class="form-label">Total</label>
                                <input type="number" class="form-control" id="totalMember" disabled>
                            </div>
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-save"></i> Simpan Transaksi Member
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal untuk transaksi Semi -->
        <div class="modal fade" id="modalTransaksiSemi" tabindex="-1" aria-labelledby="modalTransaksiSemiLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTransaksiSemiLabel">Transaksi Semi</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="transaksiSemiForm">
                            <div class="mb-3">
                                <label for="semiId" class="form-label">ID Semi</label>
                                <input type="text" class="form-control" id="semiId" required>
                            </div>
                            <div class="mb-3">
                                <label for="produkSemi" class="form-label">Produk</label>
                                <select class="form-control" id="produkSemi" required>
                                    <!-- Opsi produk akan dimuat di sini -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="jumlahSemi" class="form-label">Jumlah</label>
                                <input type="number" class="form-control" id="jumlahSemi" required>
                            </div>
                            <div class="mb-3">
                                <label for="diskonSemi" class="form-label">Diskon (%)</label>
                                <input type="number" class="form-control" id="diskonSemi" value="0" required>
                            </div>
                            <div class="mb-3">
                                <label for="totalSemi" class="form-label">Total</label>
                                <input type="number" class="form-control" id="totalSemi" disabled>
                            </div>
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-save"></i> Simpan Transaksi Semi
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabel Riwayat Transaksi -->
        <table class="table table-striped mt-5" id="riwayatTransaksiTable">
            <thead>
                <tr>
                    <th>ID Transaksi</th>
                    <th>Nama Produk</th>
                    <th>Item</th>
                    <th>Stok</th>
                    <th>Jumlah</th>
                    <th>Total</th>
                    <th>Diskon</th>
                    <th>Bayar</th>
                    <th>Bukti Bayar</th>
                    <th>Struk</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
                <!-- Daftar transaksi akan dimuat di sini -->
            </tbody>
        </table>

        <!-- Struk Transaksi -->
        <div class="struk-container" id="strukContainer">
            <h3>Struk Pembayaran</h3>
            <div id="strukContent"></div>
            <button class="btn btn-primary" onclick="window.print()">Print Struk</button>
        </div>
    </div>

    <script>
        const transaksiList = JSON.parse(localStorage.getItem("transaksi")) || [];
        const produkList = JSON.parse(localStorage.getItem("produk")) || [];

        // Fungsi untuk membuat ID transaksi unik
        const generateTransaksiId = () => {
            const timestamp = new Date().getTime();
            return `TRX-${timestamp}`;
        };

        // Fungsi untuk menampilkan produk dalam dropdown
        const renderProdukOptions = (produkId) => {
            const produkSelect = document.getElementById(produkId);
            produkSelect.innerHTML = "";
            produkList.forEach(produk => {
                let option = document.createElement("option");
                option.value = produk.id;
                option.innerText = produk.nama;
                produkSelect.appendChild(option);
            });
        };

        // Fungsi untuk menampilkan riwayat transaksi
        const renderRiwayatTransaksi = () => {
            const riwayatTable = document.getElementById("riwayatTransaksiTable").getElementsByTagName('tbody')[0];
            riwayatTable.innerHTML = "";
            transaksiList.forEach(transaksi => {
                let row = riwayatTable.insertRow();
                row.insertCell(0).innerText = transaksi.id;
                row.insertCell(1).innerText = transaksi.produk;
                row.insertCell(2).innerText = transaksi.item;
                row.insertCell(3).innerText = transaksi.stok;
                row.insertCell(4).innerText = transaksi.jumlah;
                row.insertCell(5).innerText = transaksi.total;
                row.insertCell(6).innerText = transaksi.diskon;
                row.insertCell(7).innerText = transaksi.bayar;
                
                // Membuat tombol lihat bukti bayar
                let viewBuktiBayar = document.createElement("button");
                viewBuktiBayar.classList.add("btn", "btn-info");
                viewBuktiBayar.innerHTML = '<i class="fas fa-eye"></i> Lihat';
                viewBuktiBayar.onclick = () => viewBuktiBayar(transaksi.id);
                row.insertCell(8).appendChild(viewBuktiBayar);
                
                // Membuat tombol struk
                let printStruk = document.createElement("button");
                printStruk.classList.add("btn", "btn-primary");
                printStruk.innerHTML = '<i class="fas fa-print"></i> Struk';
                printStruk.onclick = () => printStruk(transaksi.id);
                row.insertCell(9).appendChild(printStruk);
                
                // Tombol hapus transaksi
                let deleteButton = document.createElement("button");
                deleteButton.classList.add("btn", "btn-danger");
                deleteButton.innerHTML = '<i class="fas fa-trash"></i> Hapus';
                deleteButton.onclick = () => deleteTransaksi(transaksi.id);
                row.insertCell(10).appendChild(deleteButton);
            });
        };

        const viewBuktiBayar = (id) => {
            const transaksi = transaksiList.find(t => t.id === id);
            const buktiBayarContainer = document.getElementById("strukContent");
            buktiBayarContainer.innerHTML = `<img src="${transaksi.buktiBayar}" alt="Bukti Bayar" class="img-fluid" />`;
            document.getElementById("strukContainer").style.display = "block";
        };

        const printStruk = (id) => {
            const transaksi = transaksiList.find(t => t.id === id);
            const strukContainer = document.getElementById("strukContent");
            strukContainer.innerHTML = `
                <h4>Transaksi ID: ${transaksi.id}</h4>
                <p>Produk: ${transaksi.produk}</p>
                <p>Jumlah: ${transaksi.jumlah}</p>
                <p>Total: ${transaksi.total}</p>
                <p>Diskon: ${transaksi.diskon}</p>
                <p>Bayar: ${transaksi.bayar}</p>
                <p>Bukti Bayar: <img src="${transaksi.buktiBayar}" alt="Bukti Bayar" style="width:100px;" /></p>
            `;
            document.getElementById("strukContainer").style.display = "block";
        };

        const deleteTransaksi = (id) => {
            if (confirm("Apakah Anda yakin ingin menghapus transaksi ini?")) {
                const index = transaksiList.findIndex(t => t.id === id);
                if (index !== -1) {
                    transaksiList.splice(index, 1);
                    localStorage.setItem("transaksi", JSON.stringify(transaksiList));
                    renderRiwayatTransaksi();
                }
            }
        };

        document.getElementById("transaksiForm").addEventListener("submit", (e) => {
            e.preventDefault();
            const transaksi = {
                id: generateTransaksiId(),
                produk: document.getElementById("produkId").value,
                item: "Item Name", // Dapatkan dari produk
                stok: 100, // Atur stok sesuai data produk
                jumlah: document.getElementById("jumlah").value,
                total: calculateTotal(),
                diskon: document.getElementById("diskon").value,
                bayar: document.getElementById("bayar").value,
                buktiBayar: URL.createObjectURL(document.getElementById("buktiBayar").files[0]),
            };
            transaksiList.push(transaksi);
            localStorage.setItem("transaksi", JSON.stringify(transaksiList));
            renderRiwayatTransaksi();
        });

        const calculateTotal = () => {
            const harga = 100; // Ganti dengan harga produk
            const jumlah = document.getElementById("jumlah").value;
            const diskon = document.getElementById("diskon").value;
            let total = harga * jumlah;
            total -= (total * diskon) / 100;
            return total;
        };

        renderProdukOptions("produkId");
        renderRiwayatTransaksi();
    </script>
</body>
</html>
