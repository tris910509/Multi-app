<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaksi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1200px;
        }
        #keranjangTable td, #keranjangTable th {
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2 class="text-center mb-4"><i class="fas fa-shopping-cart"></i> Halaman Transaksi</h2>

        <!-- Form Transaksi -->
        <div class="card mb-3">
            <div class="card-header"><strong>Form Transaksi</strong></div>
            <div class="card-body">
                <form id="formTransaksi">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="idTransaksi" class="form-label">ID Transaksi</label>
                            <input type="text" class="form-control" id="idTransaksi" disabled>
                        </div>
                        <div class="col-md-6">
                            <label for="pelangganJenis" class="form-label">Jenis Pelanggan</label>
                            <select class="form-select" id="pelangganJenis">
                                <option value="umum" selected>Umum</option>
                                <option value="member">Member</option>
                            </select>
                        </div>
                        <div id="inputPelanggan" class="col-md-12 mt-3">
                            <label for="namaPelanggan" class="form-label">Nama Pelanggan</label>
                            <input type="text" class="form-control" id="namaPelanggan" placeholder="Masukkan nama pelanggan">
                        </div>
                        <div id="selectMember" class="col-md-12 mt-3 d-none">
                            <label for="memberPelanggan" class="form-label">Pilih Member</label>
                            <select class="form-select" id="memberPelanggan">
                                <!-- Data member dimuat di sini -->
                            </select>
                        </div>
                    </div>

                    <hr class="my-4">
                    <h5>Pilih Produk</h5>
                    <div class="row g-3 align-items-center">
                        <div class="col-md-5">
                            <label for="produkId" class="form-label">Produk</label>
                            <select class="form-select" id="produkId">
                                <!-- Data produk dimuat di sini -->
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="jumlahProduk" class="form-label">Jumlah</label>
                            <input type="number" class="form-control" id="jumlahProduk" min="1" value="1">
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-primary w-100 mt-2" id="btnTambahKeranjang">
                                <i class="fas fa-plus"></i> Tambahkan ke Keranjang
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Keranjang Belanja -->
        <div class="card mb-3">
            <div class="card-header"><strong>Keranjang Belanja</strong></div>
            <div class="card-body">
                <table class="table table-bordered" id="keranjangTable">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Nama Produk</th>
                            <th>Jumlah</th>
                            <th>Harga</th>
                            <th>Total</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data keranjang dimuat di sini -->
                    </tbody>
                </table>
                <div class="text-end">
                    <h5>Total Belanja: <span id="totalBelanja">Rp 0</span></h5>
                </div>
            </div>
        </div>

        <!-- Konfirmasi Pembayaran -->
        <div class="card">
            <div class="card-header"><strong>Konfirmasi Pembayaran</strong></div>
            <div class="card-body">
                <form id="formPembayaran">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="diskon" class="form-label">Diskon (%)</label>
                            <input type="number" class="form-control" id="diskon" min="0" max="100" value="0">
                        </div>
                        <div class="col-md-6">
                            <label for="metodePembayaran" class="form-label">Metode Pembayaran</label>
                            <select class="form-select" id="metodePembayaran">
                                <option value="cash" selected>Cash</option>
                                <option value="debit">Debit</option>
                                <option value="kredit">Kredit</option>
                                <option value="transfer">Transfer</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="bayar" class="form-label">Pembayaran</label>
                            <input type="number" class="form-control" id="bayar" min="0" required>
                        </div>
                        <div class="col-md-6">
                            <label for="kembalian" class="form-label">Kembalian</label>
                            <input type="text" class="form-control" id="kembalian" disabled>
                        </div>
                    </div>
                    <button type="button" class="btn btn-success w-100 mt-3" id="btnSelesaiTransaksi">
                        <i class="fas fa-check"></i> Selesaikan Transaksi
                    </button>
                </form>
            </div>
        </div>

        <!-- Riwayat Transaksi -->
        <div class="card mt-4">
            <div class="card-header"><strong>Riwayat Transaksi</strong></div>
            <div class="card-body">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>ID Transaksi</th>
                            <th>Pelanggan</th>
                            <th>Total Belanja</th>
                            <th>Metode Pembayaran</th>
                            <th>Tanggal</th>
                        </tr>
                    </thead>
                    <tbody id="riwayatTransaksiTable">
                        <!-- Data riwayat transaksi dimuat di sini -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    // Inisialisasi localStorage
    if (!localStorage.getItem('produk')) {
        localStorage.setItem('produk', JSON.stringify([
            { id: 'P001', nama: 'Produk A', harga: 10000, stok: 50, kategori: 'Kategori 1' },
            { id: 'P002', nama: 'Produk B', harga: 20000, stok: 30, kategori: 'Kategori 2' }
        ]));
    }

    if (!localStorage.getItem('riwayatTransaksi')) {
        localStorage.setItem('riwayatTransaksi', JSON.stringify([]));
    }

    const produkData = JSON.parse(localStorage.getItem('produk'));
    const riwayatTransaksi = JSON.parse(localStorage.getItem('riwayatTransaksi'));
    let keranjang = [];

    // Fungsi untuk menghasilkan ID Transaksi unik
    const generateIdTransaksi = () => 'TRX' + Date.now();

    // Fungsi untuk menampilkan data produk di dropdown
    const tampilkanProduk = () => {
        const produkSelect = document.getElementById('produkId');
        produkSelect.innerHTML = '';
        produkData.forEach(produk => {
            const option = document.createElement('option');
            option.value = produk.id;
            option.textContent = `${produk.nama} - Rp ${produk.harga}`;
            produkSelect.appendChild(option);
        });
    };

    // Fungsi untuk menambahkan produk ke keranjang
    const tambahKeKeranjang = () => {
        const produkId = document.getElementById('produkId').value;
        const jumlah = parseInt(document.getElementById('jumlahProduk').value);

        const produk = produkData.find(p => p.id === produkId);
        if (!produk) return alert('Produk tidak ditemukan');
        if (jumlah > produk.stok) return alert('Stok tidak mencukupi');

        const produkDiKeranjang = keranjang.find(item => item.id === produkId);
        if (produkDiKeranjang) {
            produkDiKeranjang.jumlah += jumlah;
        } else {
            keranjang.push({ ...produk, jumlah });
        }

        tampilkanKeranjang();
    };

    // Fungsi untuk menampilkan keranjang
    const tampilkanKeranjang = () => {
        const keranjangTable = document.querySelector('#keranjangTable tbody');
        keranjangTable.innerHTML = '';

        let total = 0;
        keranjang.forEach((item, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${item.nama}</td>
                <td>${item.jumlah}</td>
                <td>Rp ${item.harga}</td>
                <td>Rp ${item.jumlah * item.harga}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="hapusDariKeranjang(${index})">
                        <i class="fas fa-trash"></i> Hapus
                    </button>
                </td>
            `;
            keranjangTable.appendChild(row);
            total += item.jumlah * item.harga;
        });

        document.getElementById('totalBelanja').textContent = `Rp ${total}`;
    };

    // Fungsi untuk menghapus item dari keranjang
    const hapusDariKeranjang = (index) => {
        keranjang.splice(index, 1);
        tampilkanKeranjang();
    };

    // Fungsi untuk menyelesaikan transaksi
    const selesaikanTransaksi = () => {
        const diskon = parseInt(document.getElementById('diskon').value) || 0;
        const metodePembayaran = document.getElementById('metodePembayaran').value;
        const bayar = parseInt(document.getElementById('bayar').value);

        const totalBelanja = keranjang.reduce((acc, item) => acc + item.jumlah * item.harga, 0);
        const totalSetelahDiskon = totalBelanja - (totalBelanja * diskon / 100);

        if (bayar < totalSetelahDiskon) return alert('Pembayaran tidak mencukupi');

        const kembalian = bayar - totalSetelahDiskon;
        document.getElementById('kembalian').value = `Rp ${kembalian}`;

        // Simpan transaksi ke localStorage
        const transaksiBaru = {
            idTransaksi: generateIdTransaksi(),
            pelanggan: document.getElementById('namaPelanggan').value || 'Umum',
            keranjang,
            totalBelanja: totalSetelahDiskon,
            metodePembayaran,
            tanggal: new Date().toLocaleString()
        };

        riwayatTransaksi.push(transaksiBaru);
        localStorage.setItem('riwayatTransaksi', JSON.stringify(riwayatTransaksi));

        // Kosongkan keranjang dan reset form
        keranjang = [];
        tampilkanKeranjang();
        alert('Transaksi berhasil disimpan!');
        document.getElementById('formPembayaran').reset();
    };

    // Fungsi untuk menampilkan riwayat transaksi
    const tampilkanRiwayatTransaksi = () => {
        const riwayatTable = document.getElementById('riwayatTransaksiTable');
        riwayatTable.innerHTML = '';

        riwayatTransaksi.forEach((transaksi, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${transaksi.idTransaksi}</td>
                <td>${transaksi.pelanggan}</td>
                <td>Rp ${transaksi.totalBelanja}</td>
                <td>${transaksi.metodePembayaran}</td>
                <td>${transaksi.tanggal}</td>
            `;
            riwayatTable.appendChild(row);
        });
    };

    // Inisialisasi halaman
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('idTransaksi').value = generateIdTransaksi();
        tampilkanProduk();
        tampilkanKeranjang();
        tampilkanRiwayatTransaksi();

        // Event Listener
        document.getElementById('btnTambahKeranjang').addEventListener('click', tambahKeKeranjang);
        document.getElementById('btnSelesaiTransaksi').addEventListener('click', selesaikanTransaksi);

        // Tampilkan form pelanggan berdasarkan jenis pelanggan
        document.getElementById('pelangganJenis').addEventListener('change', (e) => {
            if (e.target.value === 'member') {
                document.getElementById('inputPelanggan').classList.add('d-none');
                document.getElementById('selectMember').classList.remove('d-none');
            } else {
                document.getElementById('inputPelanggan').classList.remove('d-none');
                document.getElementById('selectMember').classList.add('d-none');
            }
        });
    });
</script>

</body>
</html>
