<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halaman Transaksi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2 class="text-center mb-4"><i class="fas fa-shopping-cart"></i> Transaksi</h2>

        <!-- Form Transaksi -->
        <div class="card mb-3">
            <div class="card-header"><strong>Form Transaksi</strong></div>
            <div class="card-body">
                <form id="formTransaksi">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="idTransaksi" class="form-label">ID Transaksi</label>
                            <input type="text" class="form-control" id="idTransaksi" disabled>
                        </div>
                        <div class="col-md-4">
                            <label for="idPelanggan" class="form-label">Pelanggan</label>
                            <select class="form-select" id="idPelanggan" required>
                                <option value="">Pilih Pelanggan</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="idProduk" class="form-label">Produk</label>
                            <select class="form-select" id="idProduk" required>
                                <option value="">Pilih Produk</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="jumlahProduk" class="form-label">Jumlah</label>
                            <input type="number" class="form-control" id="jumlahProduk" required>
                        </div>
                        <div class="col-md-4">
                            <label for="diskon" class="form-label">Diskon (%)</label>
                            <input type="number" class="form-control" id="diskon" required>
                        </div>
                        <div class="col-md-4">
                            <label for="metodePembayaran" class="form-label">Metode Pembayaran</label>
                            <select class="form-select" id="metodePembayaran" required>
                                <option value="">Pilih Metode Pembayaran</option>
                                <option value="Cash">Cash</option>
                                <option value="Credit">Credit</option>
                                <option value="Debit">Debit</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="totalBayar" class="form-label">Total Bayar</label>
                            <input type="text" class="form-control" id="totalBayar" disabled>
                        </div>
                        <div class="col-md-4">
                            <label for="buktiBayar" class="form-label">Bukti Bayar</label>
                            <input type="file" class="form-control" id="buktiBayar" required>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary" id="btnSimpanTransaksi">
                            <i class="fas fa-save"></i> Simpan
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Daftar Transaksi -->
        <div class="card">
            <div class="card-header"><strong>Daftar Transaksi</strong></div>
            <div class="card-body">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>ID Transaksi</th>
                            <th>ID Pelanggan</th>
                            <th>Produk</th>
                            <th>Jumlah</th>
                            <th>Diskon</th>
                            <th>Total Bayar</th>
                            <th>Metode Pembayaran</th>
                            <th>Bukti Bayar</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="transaksiTable">
                        <!-- Data transaksi akan dimuat di sini -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Inisialisasi data transaksi
        if (!localStorage.getItem('transaksi')) {
            localStorage.setItem('transaksi', JSON.stringify([]));
        }

        if (!localStorage.getItem('pelanggan')) {
            localStorage.setItem('pelanggan', JSON.stringify([]));
        }

        if (!localStorage.getItem('produk')) {
            localStorage.setItem('produk', JSON.stringify([]));
        }

        const transaksiData = JSON.parse(localStorage.getItem('transaksi'));
        const pelangganData = JSON.parse(localStorage.getItem('pelanggan'));
        const produkData = JSON.parse(localStorage.getItem('produk'));

        // Fungsi untuk membuat ID Transaksi unik
        const generateIdTransaksi = () => {
            return 'TRX' + Date.now();
        };

        // Fungsi untuk menyimpan data transaksi ke localStorage
        const simpanTransaksi = (transaksi) => {
            transaksiData.push(transaksi);
            localStorage.setItem('transaksi', JSON.stringify(transaksiData));
            muatTabelTransaksi();
        };

        // Fungsi untuk memuat data transaksi ke tabel
        const muatTabelTransaksi = () => {
            const transaksiTable = document.getElementById('transaksiTable');
            transaksiTable.innerHTML = '';

            transaksiData.forEach((transaksi, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${transaksi.id}</td>
                    <td>${transaksi.idPelanggan}</td>
                    <td>${transaksi.produk}</td>
                    <td>${transaksi.jumlah}</td>
                    <td>${transaksi.diskon}</td>
                    <td>${transaksi.totalBayar}</td>
                    <td>${transaksi.metodePembayaran}</td>
                    <td><img src="${transaksi.buktiBayar}" alt="Bukti Bayar" width="100"></td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editTransaksi('${transaksi.id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="hapusTransaksi('${transaksi.id}')">
                            <i class="fas fa-trash"></i> Hapus
                        </button>
                    </td>
                `;
                transaksiTable.appendChild(row);
            });
        };

        // Fungsi untuk menghapus data transaksi
        const hapusTransaksi = (id) => {
            const index = transaksiData.findIndex(t => t.id === id);
            if (index !== -1) {
                transaksiData.splice(index, 1);
                localStorage.setItem('transaksi', JSON.stringify(transaksiData));
                muatTabelTransaksi();
            }
        };

        // Fungsi untuk mengisi form dengan data transaksi yang diedit
        const editTransaksi = (id) => {
            const transaksi = transaksiData.find(t => t.id === id);
            if (transaksi) {
                document.getElementById('idTransaksi').value = transaksi.id;
                document.getElementById('idPelanggan').value = transaksi.idPelanggan;
                document.getElementById('idProduk').value = transaksi.idProduk;
                document.getElementById('jumlahProduk').value = transaksi.jumlah;
                document.getElementById('diskon').value = transaksi.diskon;
                document.getElementById('metodePembayaran').value = transaksi.metodePembayaran;
                document.getElementById('totalBayar').value = transaksi.totalBayar;
                document.getElementById('buktiBayar').value = transaksi.buktiBayar;
            }
        };

        // Event listener untuk tombol simpan transaksi
        document.getElementById('btnSimpanTransaksi').addEventListener('click', () => {
            const id = document.getElementById('idTransaksi').value || generateIdTransaksi();
            const idPelanggan = document.getElementById('idPelanggan').value;
            const idProduk = document.getElementById('idProduk').value;
            const jumlah = document.getElementById('jumlahProduk').value;
            const diskon = document.getElementById('diskon').value;
            const metodePembayaran = document.getElementById('metodePembayaran').value;
            const totalBayar = (produkData.find(p => p.id === idProduk).harga * jumlah) - (diskon / 100 * produkData.find(p => p.id === idProduk).harga * jumlah);
            const buktiBayar = URL.createObjectURL(document.getElementById('buktiBayar').files[0]);

            if (idPelanggan && idProduk && jumlah && diskon && metodePembayaran && buktiBayar) {
                const transaksi = {
                    id,
                    idPelanggan,
                    produk: produkData.find(p => p.id === idProduk).nama,
                    jumlah,
                    diskon,
                    totalBayar,
                    metodePembayaran,
                    buktiBayar
                };

                // Perbarui data jika ID sudah ada
                const index = transaksiData.findIndex(t => t.id === id);
                if (index !== -1) {
                    transaksiData[index] = transaksi;
                } else {
                    simpanTransaksi(transaksi);
                }

                localStorage.setItem('transaksi', JSON.stringify(transaksiData));
                document.getElementById('formTransaksi').reset();
                document.getElementById('idTransaksi').value = '';
                muatTabelTransaksi();
            } else {
                alert('Harap lengkapi semua data!');
            }
        });

        // Muat data pelanggan dan produk saat halaman dimuat
        document.addEventListener('DOMContentLoaded', () => {
            muatTabelTransaksi();
            muatPelangganOptions();
            muatProdukOptions();
        });

        // Fungsi untuk memuat data pelanggan ke dropdown
        const muatPelangganOptions = () => {
            const pelangganSelect = document.getElementById('idPelanggan');
            pelangganData.forEach(pelanggan => {
                const option = document.createElement('option');
                option.value = pelanggan.id;
                option.textContent = pelanggan.nama;
                pelangganSelect.appendChild(option);
            });
        };

        // Fungsi untuk memuat data produk ke dropdown
        const muatProdukOptions = () => {
            const produkSelect = document.getElementById('idProduk');
            produkData.forEach(produk => {
                const option = document.createElement('option');
                option.value = produk.id;
                option.textContent = produk.nama;
                produkSelect.appendChild(option);
            });
        };
    </script>
</body>
</html>
