<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaksi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 900px;
        }
        .table th, .table td {
            text-align: center;
        }
        .keranjang-total {
            font-size: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <script>
        // Validate Access for Role (Transaksi)
        validateAccess("transaksi");
    </script>

    <!-- Navbar diambil dari script sebelumnya -->

    <div class="container mt-5">
        <h2 class="text-center mb-4"><i class="fas fa-cash-register"></i> Transaksi</h2>
        
        <!-- Form untuk memilih pelanggan dan jenis pelanggan -->
        <div class="mb-4">
            <form id="transaksiForm">
                <div class="mb-3">
                    <label for="idTransaksi" class="form-label">ID Transaksi</label>
                    <input type="text" class="form-control" id="idTransaksi" disabled>
                </div>
                <div class="mb-3">
                    <label for="jenisPelanggan" class="form-label">Jenis Pelanggan</label>
                    <select class="form-control" id="jenisPelanggan" required>
                        <option value="umum">Umum</option>
                        <option value="semi">Semi</option>
                        <option value="member">Member</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="namaPelanggan" class="form-label">Nama Pelanggan</label>
                    <input type="text" class="form-control" id="namaPelanggan" required>
                </div>
            </form>
        </div>

        <!-- Form untuk memilih produk dan menambah ke keranjang -->
        <div id="keranjangFormContainer" class="mb-4">
            <h4>Keranjang Belanja</h4>
            <form id="keranjangForm">
                <div class="mb-3">
                    <label for="produkSelect" class="form-label">Pilih Produk</label>
                    <select class="form-control" id="produkSelect" required>
                        <!-- Opsi produk akan dimuat di sini -->
                    </select>
                </div>
                <div class="mb-3">
                    <label for="jumlahSelect" class="form-label">Jumlah</label>
                    <input type="number" class="form-control" id="jumlahSelect" min="1" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-cart-plus"></i> Tambah ke Keranjang
                </button>
            </form>
        </div>

        <!-- Tabel Keranjang -->
        <h4>Daftar Keranjang</h4>
        <table class="table table-striped" id="keranjangTable">
            <thead>
                <tr>
                    <th>Produk</th>
                    <th>Jumlah</th>
                    <th>Harga Satuan</th>
                    <th>Total</th>
                    <th>Diskon</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
                <!-- Daftar produk di keranjang akan dimuat di sini -->
            </tbody>
        </table>

        <!-- Total Pembayaran -->
        <div class="keranjang-total mb-3">
            <p>Total: <span id="totalPembayaran">0</span></p>
            <p><strong>Total Setelah Potongan: <span id="totalAkhir">0</span></strong></p>
        </div>

        <!-- Tombol Checkout -->
        <button class="btn btn-success w-100" id="checkoutButton">
            <i class="fas fa-credit-card"></i> Checkout
        </button>
    </div>

    <script>
        const produkList = JSON.parse(localStorage.getItem("produk")) || [];
        const pelangganList = JSON.parse(localStorage.getItem("pelanggan")) || [];
        const keranjang = JSON.parse(localStorage.getItem("keranjang")) || [];

        // Fungsi untuk menampilkan daftar produk pada select
        const renderProdukSelect = () => {
            const produkSelect = document.getElementById("produkSelect");
            produkSelect.innerHTML = "";
            produkList.forEach(produk => {
                let option = document.createElement("option");
                option.value = produk.id;
                option.innerText = `${produk.nama} - Rp ${produk.harga}`;
                produkSelect.appendChild(option);
            });
        };

        // Fungsi untuk menampilkan keranjang belanja
        const renderKeranjang = () => {
            const keranjangTable = document.getElementById("keranjangTable").getElementsByTagName('tbody')[0];
            keranjangTable.innerHTML = "";
            let total = 0;
            keranjang.forEach(item => {
                let row = keranjangTable.insertRow();
                row.insertCell(0).innerText = item.produk.nama;
                row.insertCell(1).innerText = item.jumlah;
                row.insertCell(2).innerText = `Rp ${item.produk.harga}`;
                row.insertCell(3).innerText = `Rp ${item.total}`;
                
                let diskonInput = document.createElement("input");
                diskonInput.type = "number";
                diskonInput.classList.add("form-control");
                diskonInput.placeholder = "Diskon (%)";
                diskonInput.value = item.diskon || 0;
                diskonInput.addEventListener("input", (e) => applyDiskon(item.produk.id, e.target.value));
                row.insertCell(4).appendChild(diskonInput);

                let deleteButton = document.createElement("button");
                deleteButton.classList.add("btn", "btn-danger");
                deleteButton.innerHTML = '<i class="fas fa-trash"></i> Hapus';
                deleteButton.onclick = () => deleteItemFromKeranjang(item.produk.id);
                row.insertCell(5).appendChild(deleteButton);
                
                total += item.total;
            });

            document.getElementById("totalPembayaran").innerText = `Rp ${total}`;
            calculateTotalAfterDiscount(total);
        };

        // Fungsi untuk menghitung total setelah potongan harga
        const calculateTotalAfterDiscount = (total) => {
            const totalAkhir = total; // Karena diskon akan diterapkan per item
            document.getElementById("totalAkhir").innerText = `Rp ${totalAkhir}`;
        };

        // Fungsi untuk menambah item ke keranjang
        const addItemToKeranjang = (produkId, jumlah) => {
            const produk = produkList.find(p => p.id === produkId);
            if (produk) {
                const item = {
                    produk,
                    jumlah,
                    total: produk.harga * jumlah,
                    diskon: 0
                };
                keranjang.push(item);
                localStorage.setItem("keranjang", JSON.stringify(keranjang));
                renderKeranjang();
            }
        };

        // Fungsi untuk menghapus item dari keranjang
        const deleteItemFromKeranjang = (produkId) => {
            const index = keranjang.findIndex(item => item.produk.id === produkId);
            if (index !== -1) {
                keranjang.splice(index, 1);
                localStorage.setItem("keranjang", JSON.stringify(keranjang));
                renderKeranjang();
            }
        };

        // Fungsi untuk mengupdate diskon
        const applyDiskon = (produkId, diskon) => {
            const item = keranjang.find(item => item.produk.id === produkId);
            if (item) {
                item.diskon = parseFloat(diskon);
                item.total = item.produk.harga * item.jumlah * (1 - item.diskon / 100);
                localStorage.setItem("keranjang", JSON.stringify(keranjang));
                renderKeranjang();
            }
        };

        // Fungsi untuk checkout
        document.getElementById("checkoutButton").addEventListener("click", () => {
            if (keranjang.length === 0) {
                alert("Keranjang kosong! Tambahkan produk terlebih dahulu.");
                return;
            }
            const totalAkhir = parseInt(document.getElementById("totalAkhir").innerText.replace("Rp", "").trim());
            alert(`Checkout berhasil! Total pembayaran: Rp ${totalAkhir}`);
            localStorage.removeItem("keranjang");
            renderKeranjang();
        });

        // Event listener untuk form transaksi
        document.getElementById("transaksiForm").addEventListener("submit", (e) => {
            e.preventDefault();
            const jenisPelanggan = document.getElementById("jenisPelanggan").value;
            const namaPelanggan = document.getElementById("namaPelanggan").value;

            let pelangganData = {};
            if (jenisPelanggan === "semi" || jenisPelanggan === "member") {
                pelangganData = pelangganList.find(p => p.jenis === jenisPelanggan);
                document.getElementById("namaPelanggan").value = pelangganData ? pelangganData.nama : namaPelanggan;
            }

            const idTransaksi = `T-${new Date().getTime()}`;
            document.getElementById("idTransaksi").value = idTransaksi;

            // Simpan transaksi di localStorage jika diperlukan
            // localStorage.setItem("transaksi", JSON.stringify(...));
        });

        // Inisialisasi produk dan keranjang
        renderProdukSelect();
        renderKeranjang();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
