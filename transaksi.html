<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halaman Transaksi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1000px;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ddd;
        }
        .alert-custom {
            display: none;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2 class="text-center mb-4"><i class="fas fa-cash-register"></i> Halaman Transaksi</h2>

        <!-- Notifikasi Error / Sukses -->
        <div class="alert alert-danger alert-custom" id="errorAlert">
            <strong>Oops!</strong> Terjadi kesalahan, harap periksa kembali input Anda.
        </div>
        <div class="alert alert-success alert-custom" id="successAlert">
            <strong>Transaksi berhasil!</strong> Pembayaran telah dikonfirmasi.
        </div>

        <!-- Form Transaksi -->
        <form id="formTransaksi">
            <h5>Transaksi Baru</h5>
            <div class="mb-3">
                <label for="idTransaksi" class="form-label">ID Transaksi</label>
                <input type="text" class="form-control" id="idTransaksi" disabled>
            </div>
            <div class="mb-3">
                <label for="pelangganJenis" class="form-label">Pilih Pelanggan</label>
                <select class="form-select" id="pelangganJenis">
                    <option value="umum" selected>Umum</option>
                    <option value="member">Member</option>
                </select>
            </div>
            <div id="manualInput" class="mb-3">
                <label for="pelangganUmum" class="form-label">Nama Pelanggan</label>
                <input type="text" class="form-control" id="pelangganUmum" placeholder="Masukkan nama pelanggan umum" required>
            </div>
            <div id="memberSelect" class="mb-3 d-none">
                <label for="pelangganMember" class="form-label">Pilih Member</label>
                <select class="form-select" id="pelangganMember" required>
                    <!-- Data member akan dimuat di sini -->
                </select>
            </div>
            <div class="mb-3">
                <label for="produkId" class="form-label">Pilih Produk</label>
                <select class="form-select" id="produkId" required>
                    <!-- Data produk akan dimuat di sini -->
                </select>
            </div>
            <div class="mb-3">
                <label for="jumlahProduk" class="form-label">Jumlah</label>
                <input type="number" class="form-control" id="jumlahProduk" min="1" value="1" required>
            </div>
            <button type="button" class="btn btn-primary" id="tambahKeKeranjang"><i class="fas fa-cart-plus"></i> Tambah ke Keranjang</button>
        </form>

        <!-- Keranjang -->
        <div id="keranjang" class="mt-4">
            <h5>Keranjang Belanja</h5>
            <div id="cartItems"></div>
            <hr>
            <div class="d-flex justify-content-between">
                <h6>Subtotal: <span id="subtotal">Rp 0</span></h6>
                <h6>Total Harga: <span id="totalHarga">Rp 0</span></h6>
            </div>
            <button class="btn btn-danger w-100" id="batalkanTransaksi"><i class="fas fa-trash"></i> Batalkan Transaksi</button>
            <button class="btn btn-success w-100 mt-3" id="konfirmasiPembayaran"><i class="fas fa-check-circle"></i> Konfirmasi Pembayaran</button>
        </div>

        <!-- Struk -->
        <div id="strukTransaksi" class="mt-5 d-none">
            <h5>Struk Transaksi</h5>
            <div class="border p-3" id="strukContent">
                <!-- Data struk akan dimuat di sini -->
            </div>
            <button class="btn btn-success mt-3" onclick="window.print()"><i class="fas fa-print"></i> Cetak Struk</button>
        </div>
    </div>

    <script>
        const produkList = JSON.parse(localStorage.getItem("produk")) || [];
        const memberList = JSON.parse(localStorage.getItem("pelanggan")) || [];
        const transaksiList = JSON.parse(localStorage.getItem("transaksi")) || [];

        let keranjang = [];

        const generateIDTransaksi = () => `TRX-${new Date().getTime()}`;

        const renderKeranjang = () => {
            const cartItemsContainer = document.getElementById("cartItems");
            cartItemsContainer.innerHTML = "";

            let subtotal = 0;
            keranjang.forEach(item => {
                const div = document.createElement("div");
                div.classList.add("cart-item");
                div.innerHTML = `
                    <span>${item.namaProduk} (x${item.jumlah})</span>
                    <span>Rp ${item.totalHarga.toLocaleString()}</span>
                    <button class="btn btn-danger btn-sm" onclick="hapusDariKeranjang('${item.idProduk}')"><i class="fas fa-trash"></i></button>
                `;
                cartItemsContainer.appendChild(div);
                subtotal += item.totalHarga;
            });

            document.getElementById("subtotal").textContent = `Rp ${subtotal.toLocaleString()}`;
            document.getElementById("totalHarga").textContent = `Rp ${subtotal.toLocaleString()}`;
        };

        const tambahKeKeranjang = () => {
            const produkId = document.getElementById("produkId").value;
            const jumlah = parseInt(document.getElementById("jumlahProduk").value) || 1;
            const produk = produkList.find(p => p.id === produkId);

            if (!produk) {
                showError("Produk tidak ditemukan");
                return;
            }

            if (jumlah > produk.stok) {
                showError("Jumlah melebihi stok yang tersedia");
                return;
            }

            const totalHarga = produk.harga * jumlah;
            keranjang.push({
                idProduk: produk.id,
                namaProduk: produk.nama,
                harga: produk.harga,
                jumlah,
                totalHarga
            });
            renderKeranjang();
        };

        const hapusDariKeranjang = (idProduk) => {
            keranjang = keranjang.filter(item => item.idProduk !== idProduk);
            renderKeranjang();
        };

        const batalkanTransaksi = () => {
            keranjang = [];
            renderKeranjang();
        };

        const konfirmasiPembayaran = () => {
            const idTransaksi = document.getElementById("idTransaksi").value;
            const pelangganJenis = document.getElementById("pelangganJenis").value;
            const pelangganNama =
                pelangganJenis === "umum"
                    ? document.getElementById("pelangganUmum").value
                    : document.getElementById("pelangganMember").selectedOptions[0].text;

            if (keranjang.length === 0) {
                showError("Keranjang belanja kosong!");
                return;
            }

            if (pelangganNama === "") {
                showError("Nama pelanggan tidak boleh kosong!");
                return;
            }

            const totalHarga = keranjang.reduce((total, item) => total + item.totalHarga, 0);

            transaksiList.push({
                id: idTransaksi,
                pelanggan: pelangganNama,
                produk: keranjang.map(item => item.namaProduk).join(", "),
                jumlah: keranjang.reduce((total, item) => total + item.jumlah, 0),
                totalHarga,
                metodePembayaran: document.getElementById("metodePembayaran").value
            });

            localStorage.setItem("transaksi", JSON.stringify(transaksiList));

            showSuccess("Transaksi berhasil dilakukan!");
            tampilkanStruk({
                id: idTransaksi,
                pelanggan: pelangganNama,
                produk: keranjang.map(item => item.namaProduk).join(", "),
                jumlah: keranjang.reduce((total, item) => total + item.jumlah, 0),
                totalHarga,
                metodePembayaran: document.getElementById("metodePembayaran").value
            });

            // Reset form dan keranjang
            document.getElementById("formTransaksi").reset();
            document.getElementById("idTransaksi").value = generateIDTransaksi();
            keranjang = [];
            renderKeranjang();
        };

        const tampilkanStruk = (transaksi) => {
            const strukDiv = document.getElementById("strukContent");
            strukDiv.innerHTML = `
                <p><strong>ID Transaksi:</strong> ${transaksi.id}</p>
                <p><strong>Pelanggan:</strong> ${transaksi.pelanggan}</p>
                <p><strong>Produk:</strong> ${transaksi.produk}</p>
                <p><strong>Jumlah:</strong> ${transaksi.jumlah}</p>
                <p><strong>Total Harga:</strong> Rp ${transaksi.totalHarga.toLocaleString()}</p>
                <p><strong>Metode Pembayaran:</strong> ${transaksi.metodePembayaran}</p>
            `;
            document.getElementById("strukTransaksi").classList.remove("d-none");
        };

        const showError = (message) => {
            const errorAlert = document.getElementById("errorAlert");
            errorAlert.textContent = message;
            errorAlert.style.display = "block";
            setTimeout(() => errorAlert.style.display = "none", 3000);
        };

        const showSuccess = (message) => {
            const successAlert = document.getElementById("successAlert");
            successAlert.textContent = message;
            successAlert.style.display = "block";
            setTimeout(() => successAlert.style.display = "none", 3000);
        };

        document.getElementById("tambahKeKeranjang").addEventListener("click", tambahKeKeranjang);
        document.getElementById("batalkanTransaksi").addEventListener("click", batalkanTransaksi);
        document.getElementById("konfirmasiPembayaran").addEventListener("click", konfirmasiPembayaran);

        // Inisialisasi
        document.getElementById("idTransaksi").value = generateIDTransaksi();
        renderSelectOptions("produkId", produkList, "Pilih Produk");
        renderSelectOptions("pelangganMember", memberList, "Pilih Member");
        renderKeranjang();
    </script>
</body>
</html>
